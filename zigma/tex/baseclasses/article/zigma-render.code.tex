%% Zigma LaTeX Class - Article Plugin
%% Rendering implementation for standard article class

%% ========================================================================
%% Article Plugin - Layout Configuration
%% ========================================================================

% Apply geometry with class option values (defaults in zigma.cls)
% Defaults: 1.25cm left/right, 2cm top/bottom, 15pt columnsep
% Override with: \documentclass[marginleft=3cm,margintop=2.5cm,...]{zigma}
\RequirePackage{geometry}
\geometry{
  left=\zigma@marginleft,
  right=\zigma@marginright,
  top=\zigma@margintop,
  bottom=\zigma@marginbottom
}

% Column separation from class option
\setlength{\columnsep}{\zigma@columnsep}

%% ========================================================================
%% Article Plugin - Header/Footer Configuration
%% ========================================================================

% Load fancyhdr for customizable headers and footers
\RequirePackage{fancyhdr}
\pagestyle{fancy}

% Configure headers using zigma variables (with fallbacks)
\fancyhead[L]{\small\itshape\g_zigma_header_left_tl}
\fancyhead[C]{\small\itshape\g_zigma_header_center_tl}
\fancyhead[R]{\small\itshape\g_zigma_header_right_tl}

% Configure footers using zigma variables (with fallbacks)
\fancyfoot[L]{\small\g_zigma_footer_left_tl}
\fancyfoot[C]{\small\thepage}
\fancyfoot[R]{\small\g_zigma_footer_right_tl}

% No header/footer rules by default
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}

\ExplSyntaxOn

%% ========================================================================
%% Article Plugin - Maketitle Implementation
%% ========================================================================

% This plugin provides the rendering layer for standard LaTeX article class
% It implements \maketitle and other document structure commands

\zigma_log:n { [PLUGIN]~Loading~article~plugin }

%% ========================================================================
%% Maketitle Rendering
%% ========================================================================

\cs_new_protected:Npn \zigma_article_render_title:
  {
    \zigma_log:n { [ARTICLE~PLUGIN]~Rendering~title }
    
    % Render title if set
    \tl_if_empty:NF \g_zigma_title_tl
      {
        \begin{center}
          % Check if title should be a hyperlink
          \tl_if_empty:NTF \g_zigma_title_url_tl
            {
              % No URL: render title as is
              {\bfseries\Large \tl_use:N \g_zigma_title_tl}
            }
            {
              % Has URL: make title clickable
              {\bfseries\Large \href{\g_zigma_title_url_tl}{\tl_use:N \g_zigma_title_tl}}
            }
          
          % Render subtitle if set
          \tl_if_empty:NF \g_zigma_subtitle_tl
            {
              \\[0.5em]
              {\large \tl_use:N \g_zigma_subtitle_tl}
            }
        \end{center}
        \vspace{0.5em}
      }
  }

\cs_new_protected:Npn \zigma_article_render_authors:
  {
    \zigma_log:n { [ARTICLE~PLUGIN]~Rendering~authors }
    
    % Get author count from sequence
    \int_compare:nNnT { \seq_count:N \g_zigma_author_ids_seq } > { 0 }
      {
        \begin{center}
          % Render author names with affiliation markers
          \seq_map_indexed_inline:Nn \g_zigma_author_ids_seq
            {
              \zigma_author_render_single:n { ##2 }
              \int_compare:nNnF { ##1 } = { \seq_count:N \g_zigma_author_ids_seq }
                { ,~ }
            }
        \end{center}
        
        % Render affiliations as footnotes with symbols
        \zigma_article_render_affiliations:
        
        \vspace{0.5em}
      }
  }

\cs_new_protected:Npn \zigma_author_render_single:n #1
  {
    % Get author name using ID
    \tl_clear:N \l_tmpa_tl
    \exp_args:Nc \prop_get:NnN { g_zigma_author_prop_#1 } { name } \l_tmpa_tl
    
    \quark_if_no_value:NF \l_tmpa_tl
      {
        \tl_use:N \l_tmpa_tl
        
        % Get email and add as link with envelope symbol
        \tl_clear:N \l__zigma_plugin_email_tl
        \exp_args:Nc \prop_get:NnN { g_zigma_author_prop_#1 } { email } \l__zigma_plugin_email_tl
        
        \quark_if_no_value:NF \l__zigma_plugin_email_tl
          {
            \tl_if_empty:NF \l__zigma_plugin_email_tl
              {
                \textsuperscript{
                  \href{mailto:\tl_use:N\l__zigma_plugin_email_tl}{\tiny\Letter}
                }
              }
          }
        % Get ORCID and add as link with icon
        \tl_clear:N \l__zigma_plugin_orcid_tl
        \exp_args:Nc \prop_get:NnN { g_zigma_author_prop_#1 } { orcid } \l__zigma_plugin_orcid_tl
        
        \quark_if_no_value:NF \l__zigma_plugin_orcid_tl
          {
            \tl_if_empty:NF \l__zigma_plugin_orcid_tl
              {
                \textsuperscript{
                  \href{https://orcid.org/\tl_use:N\l__zigma_plugin_orcid_tl}{\tiny\aiOrcid}
                }
              }
          }
        
        
        % Get affiliation list and add superscript markers
        \tl_clear:N \l_tmpb_tl
        \exp_args:Nc \prop_get:NnN { g_zigma_author_prop_#1 } { affiliation } \l_tmpb_tl
        
        \quark_if_no_value:NF \l_tmpb_tl
          {
            % Process comma-separated affiliation IDs
            \tl_if_empty:NF \l_tmpb_tl
              {
                \textsuperscript{
                  \clist_set:NV \l__zigma_plugin_affil_clist \l_tmpb_tl
                  \clist_map_inline:Nn \l__zigma_plugin_affil_clist
                    {
                      \zigma_affil_symbol:n { ##1 }
                    }
                }
              }
          }
        
        % Add corresponding marker if set
        \tl_clear:N \l__zigma_plugin_corr_tl
        \exp_args:Nc \prop_get:NnN { g_zigma_author_prop_#1 } { corresponding } \l__zigma_plugin_corr_tl
        
        \quark_if_no_value:NF \l__zigma_plugin_corr_tl
          {
            \str_if_eq:VnT \l__zigma_plugin_corr_tl { true }
              {
                \textsuperscript{
                  \str_case:Vn \g_zigma_corresponding_marker_tl
                    {
                      { envelope } { \Letter }
                      { star } { \ensuremath{\star} }
                      { asterisk } { * }
                    }
                }
              }
          }
      }
  }



\tl_new:N \l__zigma_plugin_email_tl

% Helper to convert affiliation ID to symbol
\cs_new:Npn \zigma_affil_symbol:n #1
  {
    \int_case:nnF { #1 }
      {
        { 0 } { \ensuremath{\dagger} }
        { 1 } { \ensuremath{\ddagger} }
        { 2 } { \ensuremath{\S} }
        { 3 } { \ensuremath{\P} }
        { 4 } { \ensuremath{\|} }
        { 5 } { \ensuremath{**} }
      }
      { \ensuremath{#1} } % fallback to number
  }

\clist_new:N \l__zigma_plugin_affil_clist
\tl_new:N \l__zigma_plugin_corr_tl

\cs_new_protected:Npn \zigma_article_render_affiliations:
  {
    % Iterate through registered affiliations
    \int_set:Nn \l_tmpa_int { 0 }
    \prop_map_inline:Nn \g_zigma_affil_prop
      {
        \par
        \noindent
        {\small \textsuperscript{ \zigma_affil_symbol:n { ##1 } } ##2 }
        \int_incr:N \l_tmpa_int
      }
  }

\cs_new_protected:Npn \zigma_article_render_date:
  {
    % Render date only if date.show is true
    \bool_if:NT \g_zigma_date_show_bool
      {
        \tl_if_empty:NF \g_zigma_date_tl
          {
            \begin{center}
              \small
              \tl_use:N \g_zigma_date_tl
            \end{center}
            \vspace{1em}
          }
      }
  }

\cs_new_protected:Npn \zigma_article_render_abstract:
  {
    % Render abstract if set
    \tl_if_empty:NF \g_zigma_abstract_tl
      {
        \begin{abstract}
          \tl_use:N \g_zigma_abstract_tl
        \end{abstract}
      }
  }

\cs_new_protected:Npn \zigma_article_render_keywords:
  {
    % Render keywords if set
    \tl_if_empty:NF \g_zigma_keywords_tl
      {
        \par
        \vspace{0.5em}
        \noindent
        \textbf{Keywords:}~\tl_use:N \g_zigma_keywords_tl
        \par
        \vspace{1em}
      }
  }

\cs_new_protected:Npn \zigma_article_render_metadata_footer:
  {
    % Count metadata items to show
    \int_zero:N \l_tmpa_int
    \tl_if_empty:NF \g_zigma_meta_doi_tl { \int_incr:N \l_tmpa_int }
    \tl_if_empty:NF \g_zigma_meta_url_tl { \int_incr:N \l_tmpa_int }
    \tl_if_empty:NF \g_zigma_meta_received_tl { \int_incr:N \l_tmpa_int }
    \tl_if_empty:NF \g_zigma_meta_revised_tl { \int_incr:N \l_tmpa_int }
    \tl_if_empty:NF \g_zigma_meta_accepted_tl { \int_incr:N \l_tmpa_int }
    \tl_if_empty:NF \g_zigma_meta_published_tl { \int_incr:N \l_tmpa_int }
    \tl_if_empty:NF \g_zigma_meta_license_tl { \int_incr:N \l_tmpa_int }
    
    % Only render if we have metadata to show
    \int_compare:nNnT { \l_tmpa_int } > { 0 }
      {
        \par
        \vspace{1em}
        \noindent
        \hrulefill
        \par
        \vspace{0.5em}
        
        % DOI with clickable link
        \tl_if_empty:NF \g_zigma_meta_doi_tl
          {
            \noindent
            {\small\bfseries DOI:}~
            {\small\href{https://doi.org/\g_zigma_meta_doi_tl}{\g_zigma_meta_doi_tl}}
            \par
          }
        
        % URL with clickable link and optional display text
        \tl_if_empty:NF \g_zigma_meta_url_tl
          {
            \noindent
            {\small\bfseries URL:}~
            \tl_if_empty:NTF \g_zigma_meta_url_show_tl
              { {\small\href{\g_zigma_meta_url_tl}{\g_zigma_meta_url_tl}} }
              { {\small\href{\g_zigma_meta_url_tl}{\g_zigma_meta_url_show_tl}} }
            \par
          }
        
        % Dates on same line (compact)
        \tl_if_empty:NF \g_zigma_meta_received_tl
          {
            \noindent
            {\small\bfseries Received:}~{\small\g_zigma_meta_received_tl}\hspace{1em}
          }
        \tl_if_empty:NF \g_zigma_meta_revised_tl
          {
            {\small\bfseries Revised:}~{\small\g_zigma_meta_revised_tl}\hspace{1em}
          }
        \tl_if_empty:NF \g_zigma_meta_accepted_tl
          {
            {\small\bfseries Accepted:}~{\small\g_zigma_meta_accepted_tl}
          }
        % New line after dates if any were present
        \tl_if_empty:NF \g_zigma_meta_received_tl { \par }
        
        % Published date on separate line
        \tl_if_empty:NF \g_zigma_meta_published_tl
          {
            \noindent
            {\small\bfseries Published:}~{\small\g_zigma_meta_published_tl}
            \par
          }
        
        % License information
        \tl_if_empty:NF \g_zigma_meta_license_tl
          {
            \vspace{0.3em}
            \noindent
            {\small\g_zigma_meta_license_tl}
            \par
          }
        
        \vspace{0.5em}
        \noindent
        \hrulefill
        \par
        \vspace{1em}
      }
  }

%% ========================================================================
%% Hook into zigma's maketitle
%% ========================================================================

\cs_new_protected:Npn \zigma_article_maketitle:
  {
    % Check if we're in twocolumn mode
    \if@twocolumn
      % Use \twocolumn[...] to span both columns
      \twocolumn[
        \zigma_article_render_title:
        \zigma_article_render_authors:
        \zigma_article_render_date:
        \zigma_article_render_abstract:
        \zigma_article_render_keywords:
        \zigma_article_render_metadata_footer:
        \zigma_article_render_corresponding_footer:
      ]
    \else
      % Single column mode
      \zigma_article_render_title:
      \zigma_article_render_authors:
      \zigma_article_render_date:
      \zigma_article_render_abstract:
      \zigma_article_render_keywords:
      \zigma_article_render_metadata_footer:
      \zigma_article_render_corresponding_footer:
    \fi
  }

% Register this rendering function
\cs_gset_eq:NN \zigma_render_maketitle: \zigma_article_maketitle:


%% ============================================================================
%% Corresponding Author Footer
%% ============================================================================

\cs_new_protected:Npn \zigma_article_render_corresponding_footer:
  {
    \bool_if:NT \g_zigma_corresponding_footer_bool
      {
        % Collect corresponding authors
        \tl_clear:N \l__zigma_corr_list_tl
        \int_zero:N \l__zigma_corr_count_int
        
        \seq_map_inline:Nn \g_zigma_author_ids_seq
          {
            \tl_clear:N \l__zigma_tmp_corr_tl
            \exp_args:Nc \prop_get:NnN { g_zigma_author_prop_##1 } { corresponding } \l__zigma_tmp_corr_tl
            
            \quark_if_no_value:NF \l__zigma_tmp_corr_tl
              {
                \str_if_eq:VnT \l__zigma_tmp_corr_tl { true }
                  {
                    \int_incr:N \l__zigma_corr_count_int
                    
                    % Get email
                    \tl_clear:N \l__zigma_tmp_email_tl
                    \exp_args:Nc \prop_get:NnN { g_zigma_author_prop_##1 } { email } \l__zigma_tmp_email_tl
                    
                    \quark_if_no_value:NF \l__zigma_tmp_email_tl
                      {
                        \tl_if_empty:NF \l__zigma_tmp_email_tl
                          {
                            \int_compare:nNnTF { \l__zigma_corr_count_int } > { 1 }
                              {
                                \tl_put_right:Nn \l__zigma_corr_list_tl { ,~ }
                              }
                              { }
                            \tl_put_right:Nx \l__zigma_corr_list_tl 
                              { \exp_not:N \href{mailto:\tl_use:N\l__zigma_tmp_email_tl}{\tl_use:N\l__zigma_tmp_email_tl} }
                          }
                      }
                  }
              }
          }
        
        % Render footer if we have corresponding authors
        \int_compare:nNnT { \l__zigma_corr_count_int } > { 0 }
          {
            \vspace{1em}
            \noindent
            \textsuperscript{
              \str_case:Vn \g_zigma_corresponding_marker_tl
                {
                  { envelope } { \Letter }
                  { star } { \ensuremath{\star} }
                  { asterisk } { * }
                }
            }
            ~
            \int_compare:nNnTF { \l__zigma_corr_count_int } > { 1 }
              { Corresponding~authors:~ }
              { Corresponding~author:~ }
            \tl_use:N \l__zigma_corr_list_tl
            \par
          }
      }
  }

\int_new:N \l__zigma_corr_count_int
\tl_new:N \l__zigma_corr_list_tl
\tl_new:N \l__zigma_tmp_corr_tl
\tl_new:N \l__zigma_tmp_email_tl
\tl_new:N \l__zigma_plugin_orcid_tl

\ExplSyntaxOff

\endinput
